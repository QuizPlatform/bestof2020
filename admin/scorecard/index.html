<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Scorecard</title>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.1/css/bootstrap.min.css"
    integrity="sha384-VCmXjywReHh4PwowAiWNagnWcLhlEJLA5buUprzK8rxFgeH0kww/aWY76TfkUoSX" crossorigin="anonymous">
</head>

<body>
  <!-- <div id="navbar" class="container-fluid">
    <div class="row">
      <a href="/" class="col center">Home</a>
      <a href="/check-answers" class="col center">Check Answers</a>
      <a href="/registrationpage" class="col center">Register</a>
    </div>
  </div> -->

  <a style="padding:20px; margin:20px" href="/" class="btn btn-primary btn-sm">Home</a>
  <a style="padding:20px; margin:20px" href="/backup" class="btn btn-primary btn-sm">Backup Page</a>
  <a style="padding:20px; margin:20px" href="/register" class="btn btn-primary btn-sm">Registration Page</a>
  <a style="padding:20px; margin:20px" href="/check-answers" class="btn btn-primary btn-sm">Check answers</a>
  <a style="padding:20px; margin:20px" href="/scorecard" class="btn btn-primary btn-sm">Scorecard</a>
  <br>

  <button id="addScore" type="click" onclick="addScore()">Add Scores</button>
  <button id="showButton" type="click" onclick="showTable()">Show Results</button>
  <!-- <button id="finalUpdate" type="click" onclick="finalUpdate()">Update Database</button> -->
  <div class="scorecard">
    <table>
      <tbody>
        <tr id="tr">
          <td id="totalScore"></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="col-3">
    <table class="table" id="scoreTable">
      <thead>
        <th>SNo</th>
        <th>Team Code</th>
        <th>Score</th>
        <th>Team name</th>
      <tbody>
        <!-- make table rows according to rank via loops -->
      </tbody>
    </table>
  </div>

  <script src="https://www.gstatic.com/firebasejs/7.22.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.22.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.22.0/firebase-analytics.js"></script>

  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyB1mz728tc9dqKGLUiPOAwxBxg20Gx4mSE",
      authDomain: "quizpriyam.firebaseapp.com",
      databaseURL: "https://quizpriyam.firebaseio.com",
      projectId: "quizpriyam",
      storageBucket: "quizpriyam.appspot.com",
      messagingSenderId: "968131692426",
      appId: "1:968131692426:web:467ddbadc7ef1ac1d4ea73",
      measurementId: "G-WQTBNGZXQS"
    };
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
  </script>

  <script>
    //script for adding scores
    function addScore() {
      var scores = firebase.firestore().collection("scorecard");

      document.getElementById("totalScore").innerText = "Please Wait!"
      document.getElementById('addScore').disabled = true

      scores.get().then(query => {
        query.forEach(function (doc) {
          console.log(doc.data())
          const d = doc.data()
          console.log(d)
          var totalScore = 0;
          console.log(totalScore)
          for (i = 1; i < 13; i++) {
            var score = doc.data()[String(i)];
            if (score) {
              console.log(score)
              totalScore += score;
            }
            else break;
          }
          var setWithMerge = scores.doc(String(doc.id)).set({
            total: totalScore
          }, { merge: true })
        }); //query.foreach end
        document.getElementById("totalScore").innerText = "Total scores have been added!"
      }); // scores.get end
    }

    function showTable() {
      window.teamScore = {};
      window.teamNames = {};
      window.dict = {};
      const db = firebase.firestore()

      firebase.firestore().collection('registered').get().then(function (querySnapshot) {
        querySnapshot.forEach(function (doc) {
          window.teamNames[doc.id] = doc.data()["teamName"];
        });
      });

      var data = db.collection('scorecard').get().then(query => {
        query.forEach(function (doc) {
          window.teamScore[doc.id] = doc.data()['total']
        });

        console.log(window.teamScore)

        var items = Object.keys(window.teamScore).map(function (key) {

          return [key, window.teamScore[key], window.teamNames[key]];
        });

        // Sort the array based on the second element
        items.sort(function (first, second) {
          return second[1] - first[1];
        });

        console.log(items)

        //add data to table in html
        var tableRef = document.getElementById('scoreTable').getElementsByTagName('tbody')[0];
        tableRef.innerHTML = "";
        var c = 1;
        for (j in items) {

          var newRow = tableRef.insertRow();
          var newCell = newRow.insertCell(0);
          var newText = document.createTextNode(c.toString());
          newCell.appendChild(newText);
          var newCell = newRow.insertCell(1);
          var newText = document.createTextNode(items[j][0]);
          newCell.appendChild(newText);
          var newCell = newRow.insertCell(2);
          var newText = document.createTextNode(items[j][1]);
          newCell.appendChild(newText);
          var newCell = newRow.insertCell(3);
          var newText = document.createTextNode(items[j][2]);
          newCell.appendChild(newText);
          c += 1
        }
      });
    }

    // function finalUpdate() {
    //   alert("Bas ab mat daba dio")
    //   const db = firebase.firestore()
    //   const deleteList = ['selectedTeams', 'unselectedTeams', 'predictions', 'priority']

    //   deleteList.forEach(value => {

    //     var answersData = db.collection(value).get().then(query => {

    //       query.forEach(function (doc) {
    //         db.collection(value).doc(doc.id).delete().then(function () {
    //           console.log("Document successfully deleted!");
    //         }).catch(function (error) {
    //           console.error("Error removing document: ", error);
    //         });
    //       });
    //     });
    //   })

    //   window.teamScore = {};
    //   window.dict = {};

    //   var data = db.collection('scorecard').get().then(query => {

    //     query.forEach(function (doc) {
    //       window.teamScore[doc.id] = doc.data()['total']

    //     });

    //     console.log(window.teamScore)

    //     var items = Object.keys(window.teamScore).map(function (key) {
    //       return [key, window.teamScore[key]];
    //     });

    //     // Sort the array based on the second element
    //     items.sort(function (first, second) {
    //       return second[1] - first[1];
    //     });

    //     console.log(items)

    //     //getiing teamCode corresponding teamNo teams
    //     teamCodesData = db.collection('teamCodes').get().then(query => {

    //       query.forEach(function (doc) {
    //         window.teamCodes = doc.data()

    //       });

    //       console.log(window.teamCodes)

    //       var selectedTeams = [];
    //       for (i = 0; i < 8; i++) {
    //         selectedTeams.push(items[i][0]);
    //       }
    //       console.log(selectedTeams)

    //       var unselectedTeams = [];
    //       for (i = 0; i < items.length - 8; i++) {
    //         unselectedTeams.push(items[i + 8][0]);
    //       }
    //       console.log(unselectedTeams)

    //       var registeredTeamsData = db.collection('registeredTeams');
    //       window.registeredTeams = {};

    //       registeredTeamsData.get().then(query => {
    //         query.forEach(function (doc) {

    //           window.registeredTeams[doc.id] = doc.data()
    //         });
    //         console.log(registeredTeams)

    //         //updating team data in selectedTeams collection
    //         for (i = 0; i < 8; i++) {
    //           db.collection('selectedTeams').doc(String(i + 1)).set({
    //             teamCode: window.registeredTeams[selectedTeams[i]]['teamCode'],
    //             teamLeader: window.registeredTeams[selectedTeams[i]]['teamLeader'],
    //             teamMembers: window.registeredTeams[selectedTeams[i]]['teamMembers'],
    //             teamName: window.registeredTeams[selectedTeams[i]]['teamName'],
    //             money: 4000000
    //           });

    //         }

    //         for (i = 0; i < items.length - 8; i++) {
    //           db.collection('unselectedTeams').doc(window.registeredTeams[unselectedTeams[i]]['teamCode']).set({
    //             teamCode: window.registeredTeams[unselectedTeams[i]]['teamCode'],
    //             teamLeader: window.registeredTeams[unselectedTeams[i]]['teamLeader'],
    //             teamMembers: window.registeredTeams[unselectedTeams[i]]['teamMembers'],
    //             teamName: window.registeredTeams[unselectedTeams[i]]['teamName'],
    //             money: 3800000

    //           });
    //         }
    //       });

    //       var selectedTeamCodes = [];
    //       for (i = 0; i < 8; i++) {
    //         selectedTeamCodes.push([selectedTeams[i], window.teamCodes[selectedTeams[i]]]);
    //       }
    //       console.log(selectedTeamCodes)

    //       var unselectedTeamCodes = [];
    //       for (i = 0; i < items.length - 8; i++) {
    //         unselectedTeamCodes.push([unselectedTeams[i], window.teamCodes[unselectedTeams[i]]]);
    //       }
    //       console.log(unselectedTeamCodes)

    //       //initialising empty array corresponding selectedTeamCodes in predictions
    //       var predictions = firebase.firestore().collection("predictions");
    //       for (i = 0; i < 8; i++) {
    //         predictions.doc(selectedTeamCodes[i][1]).set({
    //           predictionArray: []
    //         });
    //       }

    //       //initialising empty array corresponding unselectedTeamCodes in priority
    //       var priority = firebase.firestore().collection("priority");
    //       for (i = 0; i < items.length - 8; i++) {
    //         priority.doc(unselectedTeamCodes[i][1]).set({
    //           priorityArray: []
    //         });
    //       }
    //     });
    //   });
    // }
  </script>

  <style>
    #scoreTable {
      text-align: center;
      margin-left: 250%;
    }

    #navbar {
      padding-top: 10px;
      padding-bottom: 10px;
      background: aliceblue;
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

</body>

</html>